<?php

/**
 * @file
 * Contains installation and update routines for Lightning Search.
 */

use Drupal\node\Entity\NodeType;
use Drupal\search_api\Entity\Index;
use Drupal\search_api\Entity\Server;

/**
 * Implements hook_install().
 */
function lightning_search_install() {
  /** @var \Drupal\node\NodeTypeInterface $node_type */
  foreach (NodeType::loadMultiple() as $node_type) {
    lightning_search_node_type_insert($node_type);
  }

  // The database server is optional configuration, to be installed only if
  // Search API DB is present. For some reason, it's not installed during a
  // normal site install, so create it now if it doesn't already exist.
  $server = Server::load('database');
  if (empty($server) && \Drupal::moduleHandler()->moduleExists('search_api_db')) {
    \Drupal::service('lightning.config_helper')
      ->optional('lightning_search')
      ->createEntity('search_api_server', 'database');

    $server = Server::load('database');
  }
  if ($server) {
    Index::load('content')->setServer($server)->enable()->save();
  }
}

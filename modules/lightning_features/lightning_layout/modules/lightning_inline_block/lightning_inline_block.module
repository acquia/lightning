<?php

use Drupal\Core\Entity\EntityInterface;
use Drupal\lightning_core\OverrideHelper as Override;
use Drupal\lightning_inline_block\Form\InlineContentForm;
use Drupal\lightning_inline_block\Plugin\DisplayBuilder\InPlaceEditorDisplayBuilder;

/**
 * Implements hook_entity_type_alter().
 */
function lightning_inline_block_entity_type_alter(array &$entity_types) {
  $entity_types['block_content']->setFormClass('panels_ipe', InlineContentForm::class);
}

/**
 * Implements hook_display_builder_alter().
 */
function lightning_inline_block_display_builder_alter(array &$definitions) {
  Override::pluginClass($definitions['ipe'], InPlaceEditorDisplayBuilder::class);
}

/**
 * Implements hook_entity_delete().
 */
function lightning_inline_block_entity_delete(EntityInterface $entity) {
  $entity_id = $entity->id();

  if (is_numeric($entity_id)) {
    \Drupal::database()
      ->delete('inline_entity')
      ->condition('entity_type', $entity->getEntityTypeId())
      ->condition('entity_id', $entity_id)
      ->execute();
  }
}

/**
 * Implements hook_library_info_alter().
 */
function lightning_inline_block_library_info_alter(&$libraries, $extension) {
  if ($extension == 'panels_ipe') {
    $js = drupal_get_path('module', 'lightning_inline_block') . '/js/ajax.js';
    $js = file_create_url($js);
    $js = file_url_transform_relative($js);
    $libraries['panels_ipe']['js'][$js] = [];
  }
}

/**
 * Implements hook_panels_ipe_blocks_alter().
 */
function lightning_inline_block_panels_ipe_blocks_alter(array &$blocks = []) {
  foreach ($blocks as $i => $block) {
    if ($block['provider'] == 'lightning_inline_block') {
      unset($blocks[$i]);
    }
  }
}
